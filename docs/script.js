(()=>{var m=class{};function d(t,e){return 1200*Math.log(t/e)/Math.log(2)}function S(t){if(t=t.trim(),/^\d+$/.test(t)){let e=parseInt(t);return d(e,1)}else if(/^\d+\/\d+$/.test(t)){let e=t.split("/").map(n=>parseInt(n));return d(e[0],e[1])}else if(/^\d*.\d*$/.test(t))return parseFloat(t);throw new Error(`Could not parse pitch value: ${t}`)}function b(t){let e=t.split(`
`).filter(o=>!o.startsWith("!"));if(e.length<2)throw new Error("Invalid scale file");let n=new m;n.description=e[0];let r=parseInt(e[1]);if(n.notes=e.slice(2).filter(o=>o.length>0).map(S),n.notes.length!=r)throw new Error("Wrong number of notes in scale");return n}var i=class{};function h(t){let e=t.split(`
`).filter(r=>!r.startsWith("!"));if(e.length<7)throw new Error("Invalid mapping file");let n=new i;if(n.size=parseInt(e[0]),n.firstNote=parseInt(e[1]),n.lastNote=parseInt(e[2]),n.middleNote=parseInt(e[3]),n.referenceNote=parseInt(e[4]),n.frequency=parseFloat(e[5]),n.formalOctave=parseInt(e[6]),n.mapping=e.slice(7).map(r=>r.trim()=="x"?null:parseInt(r)),n.mapping.length!=n.size)throw new Error("Wrong number of keys in mapping");return n}function g(t){let e=new i;return e.size=t,e.firstNote=0,e.lastNote=127,e.middleNote=60,e.referenceNote=69,e.frequency=440,e.formalOctave=t,e.mapping=[...new Array(t).keys()],e}var I=128,E=31744,M=60,T=100,w=256,y=0,x=65535;function p(t,e,n){let r=new Uint8Array(I*2);for(let o=0;o<I;o++){let s=o>=e.firstNote&&o<=e.lastNote?A(t,e,o,n):E+(o-M)*w;r[o*2]=s&255,r[o*2+1]=s>>8}return r}function N(t,e){let n=t%e;for(;n<0;)n+=e;return n}function A(t,e,n,r){let o=n-1-e.middleNote,s=Math.floor(o/e.size),a=N(o+1,e.size),c=e.mapping[a],u=c===null?y:E+Math.round((t.notes[N(c-1,t.notes.length)]+s*t.notes[t.notes.length-1]+r)*w/T);return Math.max(y,Math.min(x,u))}var L=document.querySelector("#sclInput"),U=document.querySelector("#kbmInput"),k=document.querySelector("#centsInput"),_=document.querySelector("#convertButton"),f=document.querySelector("#messageArea");function l(t){f.setAttribute("style","display: block;"),f.innerText=t.message+"."}function q(){f.setAttribute("style","display: none;")}function C(t,e){let n=URL.createObjectURL(t),r=document.createElement("a");r.setAttribute("style","display: none"),r.href=n,r.download=e,document.body.appendChild(r),r.click(),setTimeout(()=>{URL.revokeObjectURL(n),document.body.removeChild(r)})}_.addEventListener("click",t=>{let e=L.files?.item(0),n=U.files?.item(0),r=k.valueAsNumber;isNaN(r)?l(new Error("Invalid cents offset")):e?e.text().then(o=>{try{let s=b(o);if(n)n.text().then(a=>{let c=h(a),u=p(s,c,r);v(u,e.name)});else{let a=g(s.notes.length),c=p(s,a,r);v(c,e.name)}}catch(s){l(s)}}):l(new Error("No scale selected"))});function v(t,e){q();try{let n=new Blob([t],{type:"application/octet-stream"});C(n,e.replace(".scl",".curve16bit"))}catch(n){l(n)}}})();
