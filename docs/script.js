(()=>{var l=class{};function f(n,e){return 1200*Math.log(n/e)/Math.log(2)}function S(n){if(n=n.trim(),/^\d+$/.test(n)){let e=parseInt(n);return f(e,1)}else if(/^\d+\/\d+$/.test(n)){let e=n.split("/").map(t=>parseInt(t));return f(e[0],e[1])}else if(/^\d*.\d*$/.test(n))return parseFloat(n);throw new Error(`Could not parse pitch value: ${n}`)}function d(n){let e=n.split(`
`).filter(o=>!o.startsWith("!"));if(e.length<2)throw new Error("Invalid scale file");let t=new l;t.description=e[0];let r=parseInt(e[1]);if(t.notes=e.slice(2).filter(o=>o.length>0).map(S),t.notes.length!=r)throw new Error("Wrong number of notes in scale");return t}var a=class{};function b(n){let e=n.split(`
`).filter(r=>!r.startsWith("!"));if(e.length<7)throw new Error("Invalid mapping file");let t=new a;if(t.size=parseInt(e[0]),t.firstNote=parseInt(e[1]),t.lastNote=parseInt(e[2]),t.middleNote=parseInt(e[3]),t.referenceNote=parseInt(e[4]),t.frequency=parseFloat(e[5]),t.formalOctave=parseInt(e[6]),t.mapping=e.slice(7).map(r=>r.trim()=="x"?null:parseInt(r)),t.mapping.length!=t.size)throw new Error("Wrong number of keys in mapping");return t}function h(n){let e=new a;return e.size=n,e.firstNote=0,e.lastNote=127,e.middleNote=60,e.referenceNote=69,e.frequency=440,e.formalOctave=n,e.mapping=[...new Array(n).keys()],e}var g=128,N=31744,v=60,M=100,E=256,y=0,T=65535;function u(n,e){let t=new Uint8Array(g*2);for(let r=0;r<g;r++){let o=r>=e.firstNote&&r<=e.lastNote?x(n,e,r):N+(r-v)*E;t[r*2]=o&255,t[r*2+1]=o>>8}return t}function I(n,e){let t=n%e;for(;t<0;)t+=e;return t}function x(n,e,t){let r=t-1-e.middleNote,o=Math.floor(r/e.size),c=I(r+1,e.size),s=e.mapping[c],i=s===null?y:N+Math.round((n.notes[I(s-1,n.notes.length)]+o*n.notes[n.notes.length-1])*E/M);return Math.max(y,Math.min(T,i))}var A=document.querySelector("#sclInput"),U=document.querySelector("#kbmInput"),k=document.querySelector("#convertButton"),m=document.querySelector("#messageArea");function p(n){m.setAttribute("style","display: block;"),m.innerText=n.message+"."}function L(){m.setAttribute("style","display: none;")}function _(n,e){let t=URL.createObjectURL(n),r=document.createElement("a");r.setAttribute("style","display: none"),r.href=t,r.download=e,document.body.appendChild(r),r.click(),setTimeout(()=>{URL.revokeObjectURL(t),document.body.removeChild(r)})}k.addEventListener("click",n=>{let e=A.files?.item(0),t=U.files?.item(0);e?e.text().then(r=>{try{let o=d(r);if(t)t.text().then(c=>{let s=b(c),i=u(o,s);w(i,e.name)});else{let c=h(o.notes.length),s=u(o,c);w(s,e.name)}}catch(o){p(o)}}):p(new Error("No scale selected"))});function w(n,e){L();try{let t=new Blob([n],{type:"application/octet-stream"});_(t,e.replace(".scl",".curve16bit"))}catch(t){p(t)}}})();
